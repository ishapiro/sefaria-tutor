# Sefaria Word Explorer (Shoresh)

A web app for reading Jewish texts with AI-powered translation and text-to-speech. An independent project of [Cogitations](https://cogitations.com), **not** a Sefaria.org project.

The project is hosted at: 

https://shoresh.cogitations.com

## About this project

This application is developed independently by Cogitations. It is not affiliated with, endorsed by, or operated by Sefaria.org.

- **Texts:** We obtain the Hebrew and English source texts via the [Sefaria API](https://developers.sefaria.org/). Sefaria provides the texts; we display them.
- **Translations:** Word-by-word analysis and translations are generated by OpenAI's GPT models via their API. Sefaria.org does not provide the translations shown here.

## Purpose

This application is designed to help students understand classical Jewish texts word by word as a way to build vocabulary and enhance their access to these texts. As a Hebrew school graduate with limited Hebrew depth, I developed it for my own study. It is provided free of charge.

Suggestions for improvements are welcome: [ishapiro@cogitations.com](mailto:ishapiro@cogitations.com)

## Architecture

| Layer | Tech |
|-------|------|
| **Frontend** | Nuxt 3, Vue 3, Tailwind CSS |
| **Server** | Nitro (Node-compatible) |
| **Deployment** | Cloudflare Workers + Workers Sites |
| **Translation Cache** | Cloudflare D1 (server-side) |
| **Index Cache** | Browser localStorage (client-side, compressed) |

### API Routes

Server routes run on Nitro and are proxied in production on Cloudflare Workers:

| Route | Purpose |
|-------|---------|
| `GET /api/sefaria/*` | Proxies requests to the Sefaria API (texts, index) |
| `POST /api/openai/chat` | Translation via OpenAI Responses API |
| `GET /api/openai/model` | Fetches preferred OpenAI model (instant/mini/turbo) |
| `POST /api/openai/tts` | Text-to-speech via OpenAI Audio API |

The client sends a Bearer token (`NUXT_PUBLIC_API_AUTH_TOKEN`) for OpenAI routes; the server validates it against `API_AUTH_TOKEN` and forwards requests with `OPENAI_API_KEY`.

## Caching

The application uses two levels of caching to improve performance and reduce API costs:

### 1. Translation Cache (Server-Side - Cloudflare D1)

Translation results are cached in a Cloudflare D1 database to avoid redundant OpenAI API calls:

- **Storage:** Cloudflare D1 database (server-side)
- **Cache Key:** SHA-256 hash of normalized phrase text
- **TTL:** 90 days (configurable)
- **Benefits:** 
  - Faster response times for previously translated phrases
  - Reduced OpenAI API costs
  - Global cache shared across all users
- **Cache Viewer:** Available at `/dictionary` route for inspecting cached translations
- **Statistics:** Cache hit/miss rates tracked in `cache_stats` table

The cache stores the full OpenAI response including:
- `originalPhrase`: Original Hebrew/Aramaic text
- `translatedPhrase`: Complete English translation
- `wordTable`: Word-by-word analysis with grammar details

See [docs/TRANSLATION-CACHE-D1-DESIGN.md](docs/TRANSLATION-CACHE-D1-DESIGN.md) for detailed design documentation.

### 2. Sefaria Index Cache (Client-Side - Browser localStorage)

The Sefaria category/book index is cached in the browser's localStorage to speed up initial page loads:

- **Storage:** Browser localStorage (client-side)
- **Data:** Minimized Sefaria index structure (only essential fields)
- **Compression:** Uses `lz-string` library when available (typically 60-80% size reduction)
- **Fallback:** Works without compression if library not installed
- **Benefits:**
  - Instant category loading on return visits
  - Reduced API calls to Sefaria
  - Works offline for cached data
- **Size Optimization:**
  - Data is minimized to only include fields needed for display/navigation
  - Compression further reduces size (e.g., 2.5 MB → 0.8 MB)
  - Handles Safari's stricter localStorage quota (5MB vs Chrome's 10MB)

**Note:** If caching fails (e.g., localStorage quota exceeded), the app will still function but will fetch the index from the API each time, resulting in slightly slower initial loads.

### Cloudflare Deployment

- **Nitro preset:** `cloudflare_module` — builds a Worker script + static assets.
- **Wrangler:** Uses `[site]` with `bucket = ".output/public"` so static files are served via Workers Sites and Nitro receives `__STATIC_CONTENT_MANIFEST`.
- **Entry:** `.output/server/index.mjs` handles both API and page rendering.

For detailed deployment steps (secrets, custom domain, troubleshooting), see [docs/DEPLOY-CLOUDFLARE.md](docs/DEPLOY-CLOUDFLARE.md).

## Quick start

To start the development environment with full support for the **translation cache** and Cloudflare D1:

```bash
cp .env.example .env
# Edit .env: set API_AUTH_TOKEN, OPENAI_API_KEY, NUXT_PUBLIC_API_AUTH_TOKEN
# Create .dev.vars for Wrangler local secrets (see below)
npm install
npm run dev
```

The `npm run dev` command will automatically build the app and start Wrangler to simulate the Cloudflare environment. The app will be available at http://localhost:8787.

## Rapid UI development

If you only need to work on the UI and do not need the translation cache:

```bash
npm run dev:ui
```

This starts the standard Nuxt dev server at http://localhost:3000. Translations will still work but will **not** be cached.

## Local Testing

### Prerequisites

Before testing locally, you need to:

1. **Set up environment variables** in `.dev.vars`:
   ```
   API_AUTH_TOKEN=your-auth-token
   OPENAI_API_KEY=your-openai-api-key
   NUXT_PUBLIC_API_AUTH_TOKEN=your-auth-token
   NUXT_SESSION_PASSWORD=your-session-password
   ```
   Optional (for Google OAuth):
   ```
   NUXT_OAUTH_GOOGLE_CLIENT_ID=your-google-client-id
   NUXT_OAUTH_GOOGLE_CLIENT_SECRET=your-google-client-secret
   ```
   Optional (for CAPTCHA on registration):
   ```
   TURNSTILE_SECRET_KEY=your-turnstile-secret-key
   NUXT_PUBLIC_TURNSTILE_SITE_KEY=your-turnstile-site-key
   ```

2. **Initialize the local D1 database** by running migrations:
   ```bash
   # Run all migrations in order
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0001_initial_schema.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0002_add_cache_version.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0003_add_prompt_hash.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0004_add_malformed_stats.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0005_auth_schema.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0006_add_user_soft_delete.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0007_pronunciation_cache.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0008_user_word_list.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0009_user_notes.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0010_notes_book_title_path.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0011_password_reset.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0012_support_tickets.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0013_support_tickets_reference.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0014_root_translation_cache.sql
   npx wrangler d1 execute sefaria-tutor-db --local --file=migrations/0015_flashcard_archive_progress_settings.sql
   ```

   **Note:** The local D1 database is stored in `.wrangler/state/v3/d1/`. If you encounter duplicate column errors, you can reset the local database by deleting this directory and re-running the migrations.

3. **Start the development server**:
   ```bash
   npm run dev
   ```

   The app will be available at http://localhost:8787.

### Troubleshooting

- **Database errors:** Make sure all migrations have been run. If you see duplicate column errors, reset the local database and re-run migrations.
- **Missing environment variables:** Ensure `.dev.vars` contains all required keys (see Prerequisites above).
- **Google OAuth errors:** If you're not using Google OAuth, the missing credentials error can be safely ignored—it won't affect other functionality.

## Deploying to Cloudflare

To publish the app to Cloudflare Workers, run:

```bash
npm run deploy
```

This script does two things:

- **Builds the app**: runs `nuxt build`, which generates the Worker bundle and static assets in `.output/`.
- **Deploys the Worker**: runs `npx wrangler deploy`, using `wrangler.toml` (entry: `.output/server/index.mjs`, static assets: `.output/public`).

Before deploying, make sure the Worker has the required **secrets/variables** set in Cloudflare (see `docs/DEPLOY-CLOUDFLARE.md`):

- `API_AUTH_TOKEN`
- `OPENAI_API_KEY`
- `NUXT_PUBLIC_API_AUTH_TOKEN` (should match `API_AUTH_TOKEN`)
- `NUXT_OAUTH_GOOGLE_CLIENT_ID` (required for Google login)
- `NUXT_OAUTH_GOOGLE_CLIENT_SECRET` (required for Google login)
- `TURNSTILE_SECRET_KEY` (required for CAPTCHA verification on registration)
- `NUXT_PUBLIC_TURNSTILE_SITE_KEY` (required for CAPTCHA widget on registration page)

**Note:** To get Turnstile keys, visit [Cloudflare Dashboard → Turnstile](https://dash.cloudflare.com/?to=/:account/turnstile) and create a new site. Use the Site Key as `NUXT_PUBLIC_TURNSTILE_SITE_KEY` and the Secret Key as `TURNSTILE_SECRET_KEY`.

## License

This project is open source under the [GNU GPL v3.0](LICENSE), matching Sefaria's license.

## Source acknowledgments

- **Texts:** [Sefaria](https://www.sefaria.org/) provides the Jewish texts we display via their public API. Sefaria's codebase is GPL-3.0; their hosted texts have individual licenses (Public Domain, Creative Commons). Please consider [donating to Sefaria](https://donate.sefaria.org/) to support their free access to Jewish texts.
- **Translation & TTS:** [OpenAI](https://openai.com/) — GPT models power the word-by-word translations and text-to-speech in this app.
